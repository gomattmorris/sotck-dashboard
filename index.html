<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Indices Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f7;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard {
            max-width: 100%;
        }
        
        .date-row {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .date-header {
            background-color: #333;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            font-size: 14px;
            gap: 5px;
        }
        
        .live-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            background-color: #ff3b30;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                opacity: 1;
            }
        }
        
        .indices {
            display: flex;
            flex-wrap: wrap;
        }
        
        .index-box {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            text-align: center;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        .index-box:last-child {
            border-right: none;
        }
        
        .index-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .index-value {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .percentage {
            font-size: 20px;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .percentage.positive {
            background-color: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }
        
        .percentage.negative {
            background-color: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }
        
        .week-change {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .last-updated {
            text-align: right;
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .index-box {
                min-width: 100%;
                border-right: none;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Indices to track
        const INDICES = [
            { symbol: "^DJI", name: "Dow Jones" },
            { symbol: "^GSPC", name: "S&P 500" },
            { symbol: "^IXIC", name: "NASDAQ" }
        ];
        
        // Due to CORS issues with Finnhub, we'll use mock data only for this personal dashboard
        function StockDashboard() {
            const [stockData, setStockData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [isMarketOpen, setIsMarketOpen] = useState(false);
            
            // Function to check if market is currently open
            const checkMarketOpen = () => {
                const now = new Date();
                const day = now.getDay();
                const hours = now.getHours();
                
                // Market is open Monday-Friday, 9:30 AM - 4:00 PM ET (simplified)
                return day >= 1 && day <= 5 && hours >= 9 && hours < 16;
            };
            
            // Function to check if a date is a trading day (M-F)
            const isTradingDay = (date) => {
                const day = date.getDay();
                return day >= 1 && day <= 5; // Monday through Friday
            };
            
            // Function to format date
            const formatDate = (date) => {
                return new Date(date).toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            };
            
            // Function to calculate week change
            const calculateWeekChange = (data, index) => {
                if (index === 0 && data.length >= 5) {
                    const latestValue = parseFloat(data[0]?.value || 0);
                    const weekAgoValue = parseFloat(data[4]?.value || 0);
                    if (latestValue && weekAgoValue) {
                        const change = ((latestValue - weekAgoValue) / weekAgoValue * 100).toFixed(2);
                        return change;
                    }
                }
                return null;
            };
            
            // Generate realistic mock data with daily trends
            const generateMockData = () => {
                console.log("Generating mock data for display");
                const today = new Date();
                const tradingDays = [];
                let dayCounter = 0;
                
                // Find the last 5 trading days
                while (tradingDays.length < 5) {
                    const date = new Date();
                    date.setDate(today.getDate() - dayCounter);
                    
                    if (isTradingDay(date)) {
                        // For current day, only include if it's a weekday
                        if (dayCounter === 0) {
                            const currentDay = date.getDay();
                            if (currentDay >= 1 && currentDay <= 5) {
                                tradingDays.push(date);
                            }
                        } else {
                            tradingDays.push(date);
                        }
                    }
                    
                    dayCounter++;
                    if (dayCounter > 10) break; // Safety check
                }
                
                // Make the data somewhat realistic with trends
                // Base values for indices
                const baseValues = {
                    "^DJI": 33900,
                    "^GSPC": 4130,
                    "^IXIC": 12800
                };
                
                // Generate a random trend direction and magnitude for the week
                const trends = INDICES.map(index => {
                    const trend = Math.random() * 2 - 1; // Between -1 and 1
                    return {
                        symbol: index.symbol,
                        trend: trend,
                        volatility: Math.random() * 0.5 + 0.5 // Between 0.5 and 1
                    };
                });
                
                // Generate data for each trading day
                const mockData = tradingDays.map((date, dateIndex) => {
                    return {
                        date: date,
                        indices: INDICES.map((index, indexIndex) => {
                            const trend = trends.find(t => t.symbol === index.symbol);
                            const baseValue = baseValues[index.symbol];
                            
                            // Calculate the value with some randomness but following the trend
                            const dayOffset = (5 - dateIndex) / 5; // Newer days have larger effect
                            const trendEffect = trend.trend * dayOffset * 0.05; // Up to 5% trend effect
                            const randomNoise = (Math.random() - 0.5) * trend.volatility * 0.02; // Up to 2% random noise
                            
                            const changePercent = (trendEffect + randomNoise) * 100;
                            const adjustedValue = baseValue * (1 + trendEffect + randomNoise);
                            
                            return {
                                symbol: index.symbol,
                                name: index.name,
                                value: adjustedValue.toFixed(2),
                                percentChange: dateIndex === 0 ? changePercent.toFixed(2) : 
                                               (changePercent * (Math.random() * 0.5 + 0.75)).toFixed(2) // Slightly different for older days
                            };
                        })
                    };
                });
                
                return mockData;
            };
            
            // Function to load mock data
            const loadMockData = () => {
                setLoading(true);
                
                try {
                    const mockData = generateMockData();
                    setStockData(mockData);
                    setLastUpdated(new Date());
                    setIsMarketOpen(checkMarketOpen());
                    setLoading(false);
                } catch (err) {
                    console.error("Error generating mock data:", err);
                    setError("Failed to load data. Please refresh the page.");
                    setLoading(false);
                }
            };
            
            // Load data on mount and set up refresh
            useEffect(() => {
                loadMockData();
                
                // Set up polling interval (every 5 minutes if market is open)
                const intervalId = setInterval(() => {
                    const marketOpen = checkMarketOpen();
                    setIsMarketOpen(marketOpen);
                    
                    if (marketOpen) {
                        loadMockData();
                    }
                }, 5 * 60 * 1000);
                
                // Set up a daily refresh at midnight
                const setupDailyRefresh = () => {
                    const now = new Date();
                    const midnight = new Date(now);
                    midnight.setHours(24, 0, 0, 0);
                    
                    const timeUntilMidnight = midnight.getTime() - now.getTime();
                    
                    setTimeout(() => {
                        loadMockData();
                        setupDailyRefresh(); // Setup for next day
                    }, timeUntilMidnight);
                };
                
                setupDailyRefresh();
                
                return () => clearInterval(intervalId);
            }, []);
            
            if (loading) return <div>Loading stock data...</div>;
            if (error) return <div>{error}</div>;
            
            return (
                <div className="dashboard">
                    <div className="header">
                        <h1>Stock Indices Dashboard</h1>
                        <p style={{marginTop: "5px", color: "#666"}}>
                            Showing data for the most recent trading days
                        </p>
                        <button 
                            onClick={loadMockData}
                            style={{
                                marginTop: "10px",
                                padding: "5px 10px",
                                backgroundColor: "#f1f1f1",
                                color: "#333",
                                border: "1px solid #ddd",
                                borderRadius: "4px",
                                cursor: "pointer",
                                fontSize: "12px"
                            }}
                        >
                            Refresh Data
                        </button>
                    </div>
                    
                    {stockData.map((dayData, dayIndex) => (
                        <div className="date-row" key={dayIndex}>
                            <div className="date-header">
                                <div>{formatDate(dayData.date)}</div>
                                {dayIndex === 0 && isMarketOpen && (
                                    <div className="live-indicator">
                                        <span className="live-dot"></span>
                                        <span>LIVE</span>
                                    </div>
                                )}
                            </div>
                            <div className="indices">
                                {dayData.indices.map((index, indexIndex) => {
                                    const weekChange = calculateWeekChange(
                                        stockData.map(d => d.indices[indexIndex]),
                                        dayIndex
                                    );
                                    
                                    return (
                                        <div className="index-box" key={index.symbol}>
                                            <div className="index-name">{index.name}</div>
                                            <div className="index-value">{index.value}</div>
                                            <div className={`percentage ${parseFloat(index.percentChange) >= 0 ? 'positive' : 'negative'}`}>
                                                {parseFloat(index.percentChange) >= 0 ? '+' : ''}{index.percentChange}%
                                            </div>
                                            {dayIndex === 0 && weekChange && (
                                                <div className="week-change">
                                                    Week: {parseFloat(weekChange) >= 0 ? '+' : ''}{weekChange}%
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                    
                    <div className="last-updated">
                        Last updated: {lastUpdated?.toLocaleTimeString()}
                        <p style={{fontSize: "12px", marginTop: "5px", color: "#999"}}>
                            * Using simulated data due to API limitations
                        </p>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<StockDashboard />, document.getElementById('root'));
    </script>
</body>
</html>