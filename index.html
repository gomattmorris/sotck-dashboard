<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Indices Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f7;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard {
            max-width: 100%;
        }
        
        .date-row {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .date-header {
            background-color: #333;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            font-size: 14px;
            gap: 5px;
        }
        
        .live-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            background-color: #ff3b30;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                opacity: 1;
            }
        }
        
        .indices {
            display: flex;
            flex-wrap: wrap;
        }
        
        .index-box {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            text-align: center;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        .index-box:last-child {
            border-right: none;
        }
        
        .index-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .index-value {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .percentage {
            font-size: 20px;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .percentage.positive {
            background-color: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }
        
        .percentage.negative {
            background-color: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }
        
        .week-change {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .last-updated {
            text-align: right;
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .data-source {
            font-size: 12px;
            margin-top: 5px;
            color: #999;
        }
        
        .api-key-form {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
            text-align: center;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .primary-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .secondary-button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .switch-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin: 0 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .error-message {
            color: #ff3b30;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .usage-info {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        
        .requests-counter {
            font-weight: bold;
            color: #2196F3;
        }
        
        @media (max-width: 768px) {
            .index-box {
                min-width: 100%;
                border-right: none;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Indices to track (with their Alpha Vantage symbols)
        const INDICES = [
            { symbol: "DIA", name: "Dow Jones" },
            { symbol: "SPY", name: "S&P 500" },
            { symbol: "QQQ", name: "NASDAQ" }
        ];
        
        function StockDashboard() {
            const [stockData, setStockData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [isMarketOpen, setIsMarketOpen] = useState(false);
            const [apiKeyInput, setApiKeyInput] = useState('');
            const [useRealData, setUseRealData] = useState(false); // Default to mock data
            const [dataSource, setDataSource] = useState('simulated');
            const [showApiKeyForm, setShowApiKeyForm] = useState(false);
            const [apiErrorMessage, setApiErrorMessage] = useState('');
            const [requestCount, setRequestCount] = useState(() => {
                const savedCount = localStorage.getItem('alphaVantageRequestCount');
                return savedCount ? parseInt(savedCount, 10) : 0;
            });
            const [requestDate, setRequestDate] = useState(() => {
                return localStorage.getItem('alphaVantageRequestDate') || new Date().toDateString();
            });
            
            // Reset request count if date changes
            useEffect(() => {
                const today = new Date().toDateString();
                if (requestDate !== today) {
                    setRequestCount(0);
                    setRequestDate(today);
                    localStorage.setItem('alphaVantageRequestCount', '0');
                    localStorage.setItem('alphaVantageRequestDate', today);
                }
            }, [requestDate]);
            
            // Function to increment request count
            const incrementRequestCount = () => {
                const newCount = requestCount + 1;
                setRequestCount(newCount);
                localStorage.setItem('alphaVantageRequestCount', newCount.toString());
            };
            
            // Alpha Vantage API key from localStorage
            const [apiKey, setApiKey] = useState(() => {
                return localStorage.getItem('alphaVantageApiKey') || '';
            });
            
            // Function to toggle data source preference
            const toggleDataSource = (useReal) => {
                setUseRealData(useReal);
                if (useReal && !apiKey) {
                    setShowApiKeyForm(true);
                } else {
                    fetchData(useReal ? apiKey : null);
                }
            };
            
            // Function to save API key and fetch real data
            const saveApiKeyAndFetch = () => {
                if (apiKeyInput.trim()) {
                    const key = apiKeyInput.trim();
                    localStorage.setItem('alphaVantageApiKey', key);
                    setApiKey(key);
                    setShowApiKeyForm(false);
                    fetchData(key);
                } else {
                    setApiErrorMessage('Please enter a valid API key');
                }
            };
            
            // Function to check if market is currently open
            const checkMarketOpen = () => {
                const now = new Date();
                const day = now.getDay();
                const hours = now.getHours();
                
                // Market is open Monday-Friday, 9:30 AM - 4:00 PM ET (simplified)
                return day >= 1 && day <= 5 && hours >= 9 && hours < 16;
            };
            
            // Function to check if a date is a trading day (M-F)
            const isTradingDay = (date) => {
                const day = date.getDay();
                return day >= 1 && day <= 5; // Monday through Friday
            };
            
            // Function to format date
            const formatDate = (date) => {
                return new Date(date).toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            };
            
            // Generate mock data for trading days
            const generateMockData = () => {
                console.log("Generating mock data");
                const today = new Date();
                const tradingDays = [];
                let dayCounter = 0;
                
                // Find the last 5 trading days
                while (tradingDays.length < 5) {
                    const date = new Date();
                    date.setDate(today.getDate() - dayCounter);
                    
                    if (isTradingDay(date)) {
                        // For current day, only include if it's a weekday
                        if (dayCounter === 0) {
                            const currentDay = date.getDay();
                            if (currentDay >= 1 && currentDay <= 5) {
                                tradingDays.push(date);
                            }
                        } else {
                            tradingDays.push(date);
                        }
                    }
                    
                    dayCounter++;
                    if (dayCounter > 10) break; // Safety check
                }
                
                // Make the data somewhat realistic with trends
                // Base values for indices based on recent values
                const baseValues = {
                    "DIA": 366.5,
                    "SPY": 448.2,
                    "QQQ": 385.9
                };
                
                // Generate a random trend direction and magnitude for the week
                const trends = INDICES.map(index => {
                    const trend = Math.random() * 2 - 1; // Between -1 and 1
                    return {
                        symbol: index.symbol,
                        trend: trend,
                        volatility: Math.random() * 0.5 + 0.5 // Between 0.5 and 1
                    };
                });
                
                // Generate data for each trading day
                const mockData = tradingDays.map((date, dateIndex) => {
                    return {
                        date: date,
                        indices: INDICES.map((index, indexIndex) => {
                            const trend = trends.find(t => t.symbol === index.symbol);
                            const baseValue = baseValues[index.symbol];
                            
                            // Calculate the value with some randomness but following the trend
                            const dayOffset = (5 - dateIndex) / 5; // Newer days have larger effect
                            const trendEffect = trend.trend * dayOffset * 0.05; // Up to 5% trend effect
                            const randomNoise = (Math.random() - 0.5) * trend.volatility * 0.02; // Up to 2% random noise
                            
                            const changePercent = (trendEffect + randomNoise) * 100;
                            const adjustedValue = baseValue * (1 + trendEffect + randomNoise);
                            
                            return {
                                symbol: index.symbol,
                                name: index.name,
                                value: adjustedValue.toFixed(2),
                                percentChange: dateIndex === 0 ? changePercent.toFixed(2) : 
                                               (changePercent * (Math.random() * 0.5 + 0.75)).toFixed(2) // Slightly different for older days
                            };
                        })
                    };
                });
                
                return mockData;
            };
            
            // Function to fetch real data from Alpha Vantage
            const fetchRealData = async (apiKey) => {
                if (!apiKey) {
                    throw new Error("API key required for real data");
                }
                
                if (requestCount >= 25) {
                    throw new Error("Daily API request limit reached (25/25). Please try again tomorrow or use simulated data.");
                }
                
                console.log("Fetching real data from Alpha Vantage");
                
                // Get trading days (we'll only show today for real data to minimize API calls)
                const today = new Date();
                const tradingDays = [today]; // Just show today to save API calls
                
                // Initialize result data structure
                const resultData = tradingDays.map(date => ({
                    date: date,
                    indices: INDICES.map(index => ({
                        symbol: index.symbol,
                        name: index.name,
                        value: 0,
                        percentChange: 0
                    }))
                }));
                
                // Fetch data for each index
                for (let i = 0; i < INDICES.length; i++) {
                    const index = INDICES[i];
                    try {
                        // Increment request counter before making API call
                        incrementRequestCount();
                        
                        // Global quote endpoint is more request-efficient
                        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${index.symbol}&apikey=${apiKey}`;
                        console.log(`Fetching data for ${index.name}`);
                        
                        const response = await axios.get(url);
                        
                        if (response.data && response.data['Global Quote']) {
                            const quote = response.data['Global Quote'];
                            
                            if (quote['05. price'] && quote['10. change percent']) {
                                const price = parseFloat(quote['05. price']).toFixed(2);
                                // Remove the % sign and convert to number
                                const changePercent = parseFloat(quote['10. change percent'].replace('%', '')).toFixed(2);
                                
                                // Update the data for this index
                                resultData[0].indices[i].value = price;
                                resultData[0].indices[i].percentChange = changePercent;
                                
                                console.log(`Successfully fetched data for ${index.name}: ${price} (${changePercent}%)`);
                            } else {
                                console.error(`Missing price or change data for ${index.name}`);
                            }
                        } else {
                            console.error(`Invalid response for ${index.name}:`, response.data);
                            if (response.data && response.data.Note && response.data.Note.includes('call frequency')) {
                                throw new Error("API call frequency exceeded. Please try again in a minute.");
                            }
                        }
                    } catch (err) {
                        console.error(`Error fetching data for ${index.name}:`, err);
                        // Continue with next index instead of failing completely
                    }
                }
                
                // Check if we received any valid data
                const hasRealData = resultData[0].indices.some(index => parseFloat(index.value) > 0);
                
                if (!hasRealData) {
                    throw new Error("No valid data received from Alpha Vantage. Please check your API key.");
                }
                
                return resultData;
            };
            
            // Main function to fetch data (either real or mock)
            const fetchData = async (apiKey = null) => {
                setLoading(true);
                setError(null);
                setApiErrorMessage('');
                
                try {
                    let data;
                    let source;
                    
                    if (apiKey && useRealData) {
                        try {
                            console.log("Attempting to fetch real data");
                            data = await fetchRealData(apiKey);
                            source = `real (${requestCount}/25 daily requests used)`;
                            console.log("Successfully fetched real data");
                        } catch (err) {
                            console.error("Error fetching real data, falling back to mock:", err);
                            data = generateMockData();
                            source = 'simulated (API error)';
                            setApiErrorMessage(`API Error: ${err.message}`);
                        }
                    } else {
                        data = generateMockData();
                        source = 'simulated';
                        console.log("Using simulated data");
                    }
                    
                    setStockData(data);
                    setDataSource(source);
                    setLastUpdated(new Date());
                    setIsMarketOpen(checkMarketOpen());
                } catch (err) {
                    console.error("Failed to fetch data:", err);
                    setError("Failed to load data. Please try again.");
                } finally {
                    setLoading(false);
                }
            };
            
            // Load data on mount - only once, no periodic updates
            useEffect(() => {
                // Initial data fetch
                if (apiKey && useRealData) {
                    fetchData(apiKey);
                } else {
                    fetchData(null);
                }
                
                // Check if market is open
                setIsMarketOpen(checkMarketOpen());
                
                // No interval for periodic updates to conserve API calls
            }, []);
            
            // API Key Form
            if (showApiKeyForm) {
                return (
                    <div className="api-key-form">
                        <h1 style={{marginBottom: "20px"}}>Stock Indices Dashboard</h1>
                        <h2 style={{marginBottom: "10px"}}>Enter Alpha Vantage API Key</h2>
                        <p style={{marginBottom: "20px", color: "#666"}}>
                            Get a free API key at <a href="https://www.alphavantage.co/support/#api-key" target="_blank" rel="noopener noreferrer">alphavantage.co</a>
                        </p>
                        <input 
                            className="input-field"
                            type="text" 
                            placeholder="Your Alpha Vantage API Key"
                            value={apiKeyInput}
                            onChange={(e) => setApiKeyInput(e.target.value)}
                        />
                        
                        {apiErrorMessage && (
                            <div className="error-message">{apiErrorMessage}</div>
                        )}
                        
                        <button 
                            className="primary-button"
                            onClick={saveApiKeyAndFetch}
                        >
                            Save Key & Fetch Data
                        </button>
                        
                        <div className="usage-info">
                            Alpha Vantage free tier allows 25 API requests per day.<br/>
                            This dashboard will only update when you manually refresh.
                        </div>
                        
                        <div style={{marginTop: "20px"}}>
                            <button 
                                className="secondary-button"
                                onClick={() => {
                                    setShowApiKeyForm(false);
                                    setUseRealData(false);
                                    fetchData(null);
                                }}
                            >
                                Cancel & Use Simulated Data
                            </button>
                        </div>
                    </div>
                );
            }
            
            if (loading) return <div>Loading stock data...</div>;
            if (error) return (
                <div>
                    <p>{error}</p>
                    <button 
                        className="primary-button"
                        style={{marginTop: "10px"}}
                        onClick={() => fetchData(useRealData ? apiKey : null)}
                    >
                        Try Again
                    </button>
                </div>
            );
            
            return (
                <div className="dashboard">
                    <div className="header">
                        <h1>Stock Indices Dashboard</h1>
                        <p style={{marginTop: "5px", color: "#666"}}>
                            Showing data for the most recent trading days
                        </p>
                        
                        <div className="switch-container">
                            <span>Simulated</span>
                            <label className="switch">
                                <input 
                                    type="checkbox" 
                                    checked={useRealData}
                                    onChange={(e) => toggleDataSource(e.target.checked)}
                                />
                                <span className="slider"></span>
                            </label>
                            <span>Real API</span>
                        </div>
                        
                        {useRealData && apiKey && (
                            <div className="usage-info">
                                API Requests Today: <span className="requests-counter">{requestCount}/25</span>
                            </div>
                        )}
                        
                        {useRealData && (
                            <button 
                                className="secondary-button"
                                onClick={() => setShowApiKeyForm(true)}
                            >
                                Change API Key
                            </button>
                        )}
                        
                        <button 
                            className="secondary-button"
                            style={{marginLeft: "10px"}}
                            onClick={() => fetchData(useRealData ? apiKey : null)}
                            disabled={useRealData && requestCount >= 25}
                        >
                            Refresh Data
                        </button>
                    </div>
                    
                    {apiErrorMessage && useRealData && (
                        <div className="error-message" style={{textAlign: "center", marginBottom: "15px"}}>
                            {apiErrorMessage}
                        </div>
                    )}
                    
                    {stockData.map((dayData, dayIndex) => (
                        <div className="date-row" key={dayIndex}>
                            <div className="date-header">
                                <div>{formatDate(dayData.date)}</div>
                                {dayIndex === 0 && isMarketOpen && (
                                    <div className="live-indicator">
                                        <span className="live-dot"></span>
                                        <span>LIVE</span>
                                    </div>
                                )}
                            </div>
                            <div className="indices">
                                {dayData.indices.map((index, indexIndex) => {
                                    return (
                                        <div className="index-box" key={index.symbol}>
                                            <div className="index-name">{index.name}</div>
                                            <div className="index-value">{index.value}</div>
                                            <div className={`percentage ${parseFloat(index.percentChange) >= 0 ? 'positive' : 'negative'}`}>
                                                {parseFloat(index.percentChange) >= 0 ? '+' : ''}{index.percentChange}%
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                    
                    <div className="last-updated">
                        Last updated: {lastUpdated?.toLocaleTimeString()}
                        <p className="data-source">
                            Data source: {dataSource}
                        </p>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<StockDashboard />, document.getElementById('root'));
    </script>
</body>
</html>