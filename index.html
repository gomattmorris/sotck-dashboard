<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Indices Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.4/axios.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f7;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .dashboard {
            max-width: 100%;
        }
        
        .date-row {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        .date-header {
            background-color: #333;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            font-size: 14px;
            gap: 5px;
        }
        
        .live-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            background-color: #ff3b30;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
            100% {
                opacity: 1;
            }
        }
        
        .indices {
            display: flex;
            flex-wrap: wrap;
        }
        
        .index-box {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            text-align: center;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        .index-box:last-child {
            border-right: none;
        }
        
        .index-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .index-value {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .percentage {
            font-size: 20px;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .percentage.positive {
            background-color: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }
        
        .percentage.negative {
            background-color: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }
        
        .week-change {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .last-updated {
            text-align: right;
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .data-source {
            font-size: 12px;
            margin-top: 5px;
            color: #999;
        }
        
        .api-key-form {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
            text-align: center;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .primary-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .secondary-button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #f1f1f1;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .switch-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin: 0 10px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        @media (max-width: 768px) {
            .index-box {
                min-width: 100%;
                border-right: none;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Indices to track
        const INDICES = [
            { symbol: "^DJI", name: "Dow Jones" },
            { symbol: "^GSPC", name: "S&P 500" },
            { symbol: "^IXIC", name: "NASDAQ" }
        ];
        
        function StockDashboard() {
            const [stockData, setStockData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [isMarketOpen, setIsMarketOpen] = useState(false);
            const [apiKey, setApiKey] = useState(() => {
                return localStorage.getItem('finnhubApiKey') || '';
            });
            const [useRealData, setUseRealData] = useState(() => {
                const savedPref = localStorage.getItem('useRealData');
                return savedPref === 'false' ? false : true; // Default to true unless explicitly set to false
            });
            const [dataSource, setDataSource] = useState('simulated');
            
            // Function to save API key
            const saveApiKey = (key) => {
                localStorage.setItem('finnhubApiKey', key);
                setApiKey(key);
            };
            
            // Function to toggle data source preference
            const toggleDataSource = (useReal) => {
                localStorage.setItem('useRealData', useReal);
                setUseRealData(useReal);
                fetchData(useReal);
            };
            
            // Function to check if market is currently open
            const checkMarketOpen = () => {
                const now = new Date();
                const day = now.getDay();
                const hours = now.getHours();
                
                // Market is open Monday-Friday, 9:30 AM - 4:00 PM ET (simplified)
                return day >= 1 && day <= 5 && hours >= 9 && hours < 16;
            };
            
            // Function to check if a date is a trading day (M-F)
            const isTradingDay = (date) => {
                const day = date.getDay();
                return day >= 1 && day <= 5; // Monday through Friday
            };
            
            // Function to format date
            const formatDate = (date) => {
                return new Date(date).toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            };
            
            // Function to calculate week change
            const calculateWeekChange = (data, index) => {
                if (index === 0 && data.length >= 5) {
                    const latestValue = parseFloat(data[0]?.value || 0);
                    const weekAgoValue = parseFloat(data[4]?.value || 0);
                    if (latestValue && weekAgoValue) {
                        const change = ((latestValue - weekAgoValue) / weekAgoValue * 100).toFixed(2);
                        return change;
                    }
                }
                return null;
            };
            
            // Generate mock data for trading days
            const generateMockData = () => {
                console.log("Generating mock data");
                const today = new Date();
                const tradingDays = [];
                let dayCounter = 0;
                
                // Find the last 5 trading days
                while (tradingDays.length < 5) {
                    const date = new Date();
                    date.setDate(today.getDate() - dayCounter);
                    
                    if (isTradingDay(date)) {
                        // For current day, only include if it's a weekday
                        if (dayCounter === 0) {
                            const currentDay = date.getDay();
                            if (currentDay >= 1 && currentDay <= 5) {
                                tradingDays.push(date);
                            }
                        } else {
                            tradingDays.push(date);
                        }
                    }
                    
                    dayCounter++;
                    if (dayCounter > 10) break; // Safety check
                }
                
                // Make the data somewhat realistic with trends
                // Base values for indices
                const baseValues = {
                    "^DJI": 33900,
                    "^GSPC": 4130,
                    "^IXIC": 12800
                };
                
                // Generate a random trend direction and magnitude for the week
                const trends = INDICES.map(index => {
                    const trend = Math.random() * 2 - 1; // Between -1 and 1
                    return {
                        symbol: index.symbol,
                        trend: trend,
                        volatility: Math.random() * 0.5 + 0.5 // Between 0.5 and 1
                    };
                });
                
                // Generate data for each trading day
                const mockData = tradingDays.map((date, dateIndex) => {
                    return {
                        date: date,
                        indices: INDICES.map((index, indexIndex) => {
                            const trend = trends.find(t => t.symbol === index.symbol);
                            const baseValue = baseValues[index.symbol];
                            
                            // Calculate the value with some randomness but following the trend
                            const dayOffset = (5 - dateIndex) / 5; // Newer days have larger effect
                            const trendEffect = trend.trend * dayOffset * 0.05; // Up to 5% trend effect
                            const randomNoise = (Math.random() - 0.5) * trend.volatility * 0.02; // Up to 2% random noise
                            
                            const changePercent = (trendEffect + randomNoise) * 100;
                            const adjustedValue = baseValue * (1 + trendEffect + randomNoise);
                            
                            return {
                                symbol: index.symbol,
                                name: index.name,
                                value: adjustedValue.toFixed(2),
                                percentChange: dateIndex === 0 ? changePercent.toFixed(2) : 
                                               (changePercent * (Math.random() * 0.5 + 0.75)).toFixed(2) // Slightly different for older days
                            };
                        })
                    };
                });
                
                return mockData;
            };
            
            // Function to get trading days
            const getTradingDays = () => {
                const today = new Date();
                const tradingDays = [];
                let dayCounter = 0;
                
                // Collect the last 5 trading days (weekdays)
                while (tradingDays.length < 5) {
                    const date = new Date();
                    date.setDate(today.getDate() - dayCounter);
                    
                    // Only include weekdays
                    if (isTradingDay(date)) {
                        // For current day, only include if market has opened today
                        // (prevents showing Saturday/Sunday as current day)
                        if (dayCounter === 0) {
                            const currentDay = date.getDay();
                            if (currentDay >= 1 && currentDay <= 5) {
                                tradingDays.push(date);
                            }
                        } else {
                            tradingDays.push(date);
                        }
                    }
                    
                    dayCounter++;
                    if (dayCounter > 10) break; // Safety check
                }
                
                // Sort trading days in descending order (newest first)
                tradingDays.sort((a, b) => b - a);
                
                return tradingDays;
            };
            
            // Function to fetch real data from Finnhub
            const fetchRealData = async () => {
                if (!apiKey) {
                    throw new Error("API key required for real data");
                }
                
                const tradingDays = getTradingDays();
                
                // Prepare result data structure with empty values
                const resultData = tradingDays.map(date => ({
                    date: date,
                    indices: INDICES.map(index => ({
                        symbol: index.symbol,
                        name: index.name,
                        value: 0,
                        percentChange: 0
                    }))
                }));
                
                // Create a proxy URL to avoid CORS issues
                const createProxyUrl = (url) => {
                    return `https://corsproxy.io/?${encodeURIComponent(url)}`;
                };
                
                // Fetch data for each index
                for (let indexIdx = 0; indexIdx < INDICES.length; indexIdx++) {
                    const index = INDICES[indexIdx];
                    try {
                        // Remove the ^ character from indices symbols for Finnhub
                        const symbol = index.symbol.replace('^', '');
                        
                        // For Dow Jones, use the DIA ETF as a proxy
                        const finnhubSymbol = symbol === 'DJI' ? 'DIA' : 
                                             symbol === 'GSPC' ? 'SPY' : 
                                             symbol === 'IXIC' ? 'QQQ' : symbol;
                        
                        // Format dates for API in UNIX timestamp (seconds)
                        const toUnixTimestamp = (date) => Math.floor(date.getTime() / 1000);
                        const now = new Date();
                        const endDate = toUnixTimestamp(now);
                        const startDate = toUnixTimestamp(new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000)); // 14 days ago
                        
                        // Use a CORS proxy for the request
                        const url = `https://finnhub.io/api/v1/stock/candle?symbol=${finnhubSymbol}&resolution=D&from=${startDate}&to=${endDate}&token=${apiKey}`;
                        const proxyUrl = createProxyUrl(url);
                        
                        const response = await axios.get(proxyUrl);
                        
                        if (response.data && response.data.s === 'ok' && response.data.c && response.data.t) {
                            const prices = response.data.c;
                            const timestamps = response.data.t;
                            
                            // Map dates to their closest data points
                            for (let dayIndex = 0; dayIndex < resultData.length; dayIndex++) {
                                const targetDate = resultData[dayIndex].date;
                                const targetTime = toUnixTimestamp(targetDate);
                                
                                // Find closest timestamp (within 24 hours)
                                let closestIdx = -1;
                                let prevIdx = -1;
                                
                                for (let j = 0; j < timestamps.length; j++) {
                                    if (Math.abs(timestamps[j] - targetTime) < 86400) {
                                        closestIdx = j;
                                        prevIdx = j > 0 ? j - 1 : -1;
                                        break;
                                    }
                                }
                                
                                if (closestIdx >= 0) {
                                    // Set the value for this day
                                    resultData[dayIndex].indices[indexIdx].value = prices[closestIdx].toFixed(2);
                                    
                                    // Calculate percentage change if we have previous data
                                    if (prevIdx >= 0) {
                                        const percentChange = ((prices[closestIdx] - prices[prevIdx]) / prices[prevIdx] * 100).toFixed(2);
                                        resultData[dayIndex].indices[indexIdx].percentChange = percentChange;
                                    }
                                }
                            }
                        }
                    } catch (err) {
                        console.error(`Error fetching data for ${index.name}:`, err);
                        throw err; // Re-throw to be caught by caller
                    }
                }
                
                // Check if we got any real data
                const hasRealData = resultData.some(day => 
                    day.indices.some(index => parseFloat(index.value) > 0)
                );
                
                if (!hasRealData) {
                    throw new Error("No real data retrieved");
                }
                
                return resultData;
            };
            
            // Main function to fetch data (either real or mock)
            const fetchData = async (useReal = useRealData) => {
                setLoading(true);
                setError(null);
                
                try {
                    let data;
                    let source;
                    
                    if (useReal && apiKey) {
                        try {
                            data = await fetchRealData();
                            source = 'real';
                            console.log("Using real data from Finnhub");
                        } catch (err) {
                            console.error("Error fetching real data, falling back to mock:", err);
                            data = generateMockData();
                            source = 'simulated (API error)';
                        }
                    } else {
                        data = generateMockData();
                        source = 'simulated';
                        console.log("Using simulated data");
                    }
                    
                    setStockData(data);
                    setDataSource(source);
                    setLastUpdated(new Date());
                    setIsMarketOpen(checkMarketOpen());
                } catch (err) {
                    console.error("Failed to fetch data:", err);
                    setError("Failed to load data. Please try again.");
                } finally {
                    setLoading(false);
                }
            };
            
            // Load data on mount and when API key or useRealData changes
            useEffect(() => {
                fetchData();
                
                // Set up polling interval (every 5 minutes if market is open)
                const intervalId = setInterval(() => {
                    const marketOpen = checkMarketOpen();
                    setIsMarketOpen(marketOpen);
                    
                    if (marketOpen) {
                        fetchData();
                    }
                }, 5 * 60 * 1000);
                
                // Set up a daily refresh at midnight
                const setupDailyRefresh = () => {
                    const now = new Date();
                    const midnight = new Date(now);
                    midnight.setHours(24, 0, 0, 0);
                    
                    const timeUntilMidnight = midnight.getTime() - now.getTime();
                    
                    setTimeout(() => {
                        fetchData();
                        setupDailyRefresh(); // Setup for next day
                    }, timeUntilMidnight);
                };
                
                setupDailyRefresh();
                
                return () => clearInterval(intervalId);
            }, [apiKey, useRealData]);
            
            // API Key Form
            if (useRealData && !apiKey) {
                return (
                    <div className="api-key-form">
                        <h1 style={{marginBottom: "20px"}}>Stock Indices Dashboard</h1>
                        <h2 style={{marginBottom: "10px"}}>Enter your Finnhub API Key</h2>
                        <p style={{marginBottom: "20px", color: "#666"}}>
                            Your key will be stored in your browser only and never shared
                        </p>
                        <input 
                            className="input-field"
                            type="text" 
                            placeholder="Your Finnhub API Key"
                            value={apiKey}
                            onChange={(e) => setApiKey(e.target.value)}
                        />
                        <button 
                            className="primary-button"
                            onClick={() => saveApiKey(apiKey)}
                        >
                            Save Key & Load Dashboard
                        </button>
                        <div style={{marginTop: "20px"}}>
                            <button 
                                className="secondary-button"
                                onClick={() => toggleDataSource(false)}
                            >
                                Use Simulated Data Instead
                            </button>
                        </div>
                    </div>
                );
            }
            
            if (loading) return <div>Loading stock data...</div>;
            if (error) return (
                <div>
                    <p>{error}</p>
                    <button 
                        className="primary-button"
                        style={{marginTop: "10px"}}
                        onClick={() => fetchData()}
                    >
                        Try Again
                    </button>
                </div>
            );
            
            return (
                <div className="dashboard">
                    <div className="header">
                        <h1>Stock Indices Dashboard</h1>
                        <p style={{marginTop: "5px", color: "#666"}}>
                            Showing data for the most recent trading days
                        </p>
                        
                        <div className="switch-container">
                            <span>Simulated</span>
                            <label className="switch">
                                <input 
                                    type="checkbox" 
                                    checked={useRealData}
                                    onChange={(e) => toggleDataSource(e.target.checked)}
                                />
                                <span className="slider"></span>
                            </label>
                            <span>Real API</span>
                        </div>
                        
                        {useRealData && (
                            <button 
                                className="secondary-button"
                                onClick={() => setApiKey('')}
                            >
                                Change API Key
                            </button>
                        )}
                        
                        <button 
                            className="secondary-button"
                            style={{marginLeft: "10px"}}
                            onClick={() => fetchData()}
                        >
                            Refresh Data
                        </button>
                    </div>
                    
                    {stockData.map((dayData, dayIndex) => (
                        <div className="date-row" key={dayIndex}>
                            <div className="date-header">
                                <div>{formatDate(dayData.date)}</div>
                                {dayIndex === 0 && isMarketOpen && (
                                    <div className="live-indicator">
                                        <span className="live-dot"></span>
                                        <span>LIVE</span>
                                    </div>
                                )}
                            </div>
                            <div className="indices">
                                {dayData.indices.map((index, indexIndex) => {
                                    const weekChange = calculateWeekChange(
                                        stockData.map(d => d.indices[indexIndex]),
                                        dayIndex
                                    );
                                    
                                    return (
                                        <div className="index-box" key={index.symbol}>
                                            <div className="index-name">{index.name}</div>
                                            <div className="index-value">{index.value}</div>
                                            <div className={`percentage ${parseFloat(index.percentChange) >= 0 ? 'positive' : 'negative'}`}>
                                                {parseFloat(index.percentChange) >= 0 ? '+' : ''}{index.percentChange}%
                                            </div>
                                            {dayIndex === 0 && weekChange && (
                                                <div className="week-change">
                                                    Week: {parseFloat(weekChange) >= 0 ? '+' : ''}{weekChange}%
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                    
                    <div className="last-updated">
                        Last updated: {lastUpdated?.toLocaleTimeString()}
                        <p className="data-source">
                            Data source: {dataSource}
                        </p>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<StockDashboard />, document.getElementById('root'));
    </script>
</body>
</html>